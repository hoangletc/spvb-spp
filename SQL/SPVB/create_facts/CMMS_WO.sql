SELECT TOP 100
    ISNULL(PLANT.PLANT_WID, 0)                              AS PLANT_WID
    , ISNULL(AST.LOCATION_WID, 0)                           AS LOC_WID
    , FORMAT(CONVERT(DATE, SCHEDSTART), 'yyyymmdd')         AS DATE_WID
    , ISNULL(AST.ASSET_WID, 0)                              AS ASSET_WID

    , CONVERT(NVARCHAR(30), WONUM)                          AS WORK_ORDERS
    , CONVERT(NVARCHAR(100), WO.[DESCRIPTION])              AS [DESCRIPTION]
    , CONVERT(nvarchar(5), WORKTYPE)                        AS [TYPE]
    , CASE WHEN SPVB_OVERHAUL = 'False'
        THEN 'N' ELSE 'Y' END                               AS OVERHAUL
    , CONVERT(NVARCHAR(50), PMNUM)                          AS PM
    , CONVERT(NVARCHAR(50), JPNUM)                          AS JOB_PLAN
    , CONVERT(NVARCHAR( 5), SITEID)                         AS [SITE]
    , CONVERT(NVARCHAR(50), WO.[LOCATION])                  AS [LOCATION]
    , CONVERT(NVARCHAR(30), ASSETNUM)                       AS ASSET_NUM
    , CONVERT(NVARCHAR(10), WO.[STATUS])                    AS [STATUS]
    , CONVERT(NVARCHAR(10), [SUPERVISOR])                   AS [SUPERVISOR]
    , CONVERT(DATETIMEOFFSET, REPORTDATE)                   AS DATE_CREATION
    , CONVERT(DATETIMEOFFSET, TARGSTARTDATE)                AS DATE_TARGET_START
    , CONVERT(DATETIMEOFFSET, SCHEDFINISH)                  AS DATE_TARGET_FINISH
    , CONVERT(DATETIMEOFFSET, SCHEDSTART)                   AS DATE_SCHEDULE_START
    , CONVERT(DATETIMEOFFSET, SCHEDFINISH)                  AS DATE_SCHEDULE_FINISH
    , CONVERT(NVARCHAR(10), WO.PARENT)                	    AS PARENT
    , CONVERT(NVARCHAR(5), WO.IS_SCHED)					    AS IS_SCHED

    , CONVERT(DATETIMEOFFSET, WO_S_WSCH_B.CHANGEDATE)       AS DATE_WSCH_BFR
    , CONVERT(DATETIMEOFFSET, WO_S_PLN_B.CHANGEDATE)        AS DATE_PLANNING_BFR
    , CONVERT(DATETIMEOFFSET, WO_S_APPRV_B.CHANGEDATE)      AS DATE_APPROVED_BFR
    , CONVERT(DATETIMEOFFSET, WO_S_FINSH_B.CHANGEDATE)      AS DATE_FINISHED_BFR
    , CONVERT(DATETIMEOFFSET, WO_S_CPLT_B.CHANGEDATE)       AS DATE_ACCEPTED_BFR
    , CONVERT(DATETIMEOFFSET, WO_S_COMP_B.CHANGEDATE)       AS DATE_COMPLETED_BFR

    , CASE WHEN WO.IS_SCHED = 'True'
        THEN CONVERT(DATETIMEOFFSET, WO_S_WSCH_A.CHANGEDATE)
        ELSE NULL
    END                                                     AS DATE_WSCH_AFT
    , CASE WHEN WO.IS_SCHED = 'True'
        THEN CONVERT(DATETIMEOFFSET, WO_S_PLN_A.CHANGEDATE)
        ELSE NULL
    END                                                     AS DATE_PLANNING_AFT
    , CASE WHEN WO.IS_SCHED = 'True'
        THEN CONVERT(DATETIMEOFFSET, WO_S_APPRV_A.CHANGEDATE)
        ELSE NULL
    END                                                     AS DATE_APPROVED_AFT
    , CASE WHEN WO.IS_SCHED = 'True'
        THEN CONVERT(DATETIMEOFFSET, WO_S_FINSH_A.CHANGEDATE)
        ELSE NULL
    END                                                     AS DATE_FINISHED_AFT
    , CASE WHEN WO.IS_SCHED = 'True'
        THEN CONVERT(DATETIMEOFFSET, WO_S_CPLT_A.CHANGEDATE)
        ELSE NULL
    END                                                     AS DATE_ACCEPTED_AFT
    , CASE WHEN WO.IS_SCHED = 'True'
        THEN CONVERT(DATETIMEOFFSET, WO_S_COMP_A.CHANGEDATE)
        ELSE NULL
    END                                                     AS DATE_COMPLETED_AFT

    , NULL AS JOB_DESCRIPTION   -- NOTE: cần join với table JOBPLAN nhưng không có
    , NULL AS SUPERVISOR_NAME   -- NOTE: Cần join với table Person nhưng không có table

    , CONVERT(
        NVARCHAR(300), 
        CONCAT_WS('~', WONUM, ASSETNUM, 
                PMNUM, SUPERVISOR, JPNUM)
    )                                                       AS W_INTEGRATION_ID
    , 'N'                                                   AS W_DELETE_FLG
    , 'N' 											        AS W_UPDATE_FLG
    , 1                                                     AS W_DATASOURCE_NUM_ID
    , GETDATE()                                             AS W_INSERT_DT
    , GETDATE()                                             AS W_UPDATE_DT
    , NULL                                                  AS W_BATCH_ID
-- INTO #W_CMMS_WO_F_tmp
FROM [FND].[W_CMMS_WO_F] WO
    LEFT JOIN [dbo].[W_PLANT_SAP_D] PLANT ON 1=1
        AND PLANT.PLANT_NAME_2 = LEFT(WO.LOCATION, 3)
    LEFT JOIN [dbo].[W_CMMS_LOC_D] LOC_X ON 1=1
        AND LOC_X.[LOCATION] = LEFT(WO.[LOCATION], 7)
    LEFT JOIN [dbo].[W_CMMS_ASSET_D] AST ON 1=1
        AND AST.[ASSET_NUM] = WO.[ASSETNUM]

    LEFT JOIN [FND].[W_CMMS_WO_STATUS_D] WO_S_WSCH_B ON 1=1
        AND WO_S_WSCH_B.PARENT = WO.WONUM
        AND WO_S_WSCH_B.STATUS = 'WSCH_BEFORE'
    LEFT JOIN [FND].[W_CMMS_WO_STATUS_D] WO_S_PLN_B ON 1=1
        AND WO_S_PLN_B.PARENT = WO.WONUM
        AND WO_S_PLN_B.STATUS = 'PLANNING_BEFORE'
    LEFT JOIN [FND].[W_CMMS_WO_STATUS_D] WO_S_APPRV_B ON 1=1
        AND WO_S_APPRV_B.PARENT = WO.WONUM
        AND WO_S_APPRV_B.STATUS = 'APPR_BEFORE'
    LEFT JOIN [FND].[W_CMMS_WO_STATUS_D] WO_S_FINSH_B ON 1=1
        AND WO_S_FINSH_B.PARENT = WO.WONUM
        AND WO_S_FINSH_B.STATUS = 'FINISHED_BEFORE'
    LEFT JOIN [FND].[W_CMMS_WO_STATUS_D] WO_S_CPLT_B ON 1=1
        AND WO_S_CPLT_B.PARENT = WO.WONUM
        AND WO_S_CPLT_B.STATUS = 'COMPLETED_BEFORE'
    LEFT JOIN [FND].[W_CMMS_WO_STATUS_D] WO_S_COMP_B ON 1=1
        AND WO_S_COMP_B.PARENT = WO.WONUM
        AND WO_S_COMP_B.STATUS = 'COMP_BEFORE'

    LEFT JOIN [FND].[W_CMMS_WO_STATUS_D] WO_S_WSCH_A ON 1=1
        AND WO_S_WSCH_A.PARENT = WO.WONUM
        AND WO_S_WSCH_A.STATUS = 'WSCH_AFTER'
    LEFT JOIN [FND].[W_CMMS_WO_STATUS_D] WO_S_PLN_A ON 1=1
        AND WO_S_PLN_A.PARENT = WO.WONUM
        AND WO_S_PLN_A.STATUS = 'PLANNING_AFTER'
    LEFT JOIN [FND].[W_CMMS_WO_STATUS_D] WO_S_APPRV_A ON 1=1
        AND WO_S_APPRV_A.PARENT = WO.WONUM
        AND WO_S_APPRV_A.STATUS = 'APPR_AFTER'
    LEFT JOIN [FND].[W_CMMS_WO_STATUS_D] WO_S_FINSH_A ON 1=1
        AND WO_S_FINSH_A.PARENT = WO.WONUM
        AND WO_S_FINSH_A.STATUS = 'FINISHED_AFTER'
    LEFT JOIN [FND].[W_CMMS_WO_STATUS_D] WO_S_CPLT_A ON 1=1
        AND WO_S_CPLT_A.PARENT = WO.WONUM
        AND WO_S_CPLT_A.STATUS = 'COMPLETED_AFTER'
    LEFT JOIN [FND].[W_CMMS_WO_STATUS_D] WO_S_COMP_A ON 1=1
        AND WO_S_COMP_A.PARENT = WO.WONUM
        AND WO_S_COMP_A.STATUS = 'COMP_AFTER'

WHERE 1=1
    AND wo.ISTASK = 'False'
    AND wo.WORKTYPE IN ('PM', 'CM') 